<script type="text/javascript">
    (function () {
        function hasProperty (obj, prop) {
            return Object.prototype.hasOwnProperty.call(obj, prop)
        }

        function isSortedAscending(arr) {
            for (let i = 0; i < arr.length - 1; i++) {
                if (arr[i + 1].offset - arr[i].offset < 0) {
                    return false;
                }
            }
            return true;
        }

        function hasDuplicates(arr) {
            let uniqueObjects = new Set();
            for (const obj of arr) {
               let identifier = `${obj.opacity}-${obj.offset}-${obj.color}`;
               if (uniqueObjects.has(identifier)) {
                   return true; // Found a duplicate
               }
               uniqueObjects.add(identifier);
            }
            return false; // No duplicates found
        }

        // Validate the options to (choose and) show configuration error if any.
        // Any changes for options (adds new or changes any value), calls validation.
        function validateColorGradient(colorGradient){
            // When no input parameter, copy all the options from the editableList to this a temporary object
            if(!colorGradient) {
                colorGradient = []

                let colorGradientList = $("#node-input-colorgradient-container").editableList('items')
                colorGradientList.each(function(i) {
                    let colorGradientItem = $(this)
                    let offset = colorGradientItem.find(".node-input-colorgradient-offset").val()
                    let color = colorGradientItem.find(".node-input-colorgradient-color").val()
                    let opacity = colorGradientItem.find(".node-input-colorgradient-opacity").val()
                    colorGradient.push({offset:offset, color:color, opacity: opacity})
                })
            }

            if (hasDuplicates(colorGradient)) {
                $("#node-colorgradient-error").text("No duplicate rows allowed")
                $("#node-colorgradient-error").show();
                return false
            }
            else if(colorGradient.length < 2){
                $("#node-colorgradient-error").text("Configure at least two lines")
                $("#node-colorgradient-error").show();
                return false
            }
            else if(!isSortedAscending(colorGradient)) {
                $("#node-colorgradient-error").text("The offset values should be ascending")
                $("#node-colorgradient-error").show();
                return false
            }
            else if(colorGradient[0].offset != 0){
                $("#node-colorgradient-error").text("The first offset should be 0")
                $("#node-colorgradient-error").show();
                return false
            }
            // A float is 1.0 when the remainder of a division by 1 is 0
            else if(colorGradient[colorGradient.length - 1].offset % 1 !== 0){
                $("#configError").text("The last offset should be 1.0")
                $("#node-colorgradient-error").show();
                return false
            }
            else if(!colorGradient.every(obj => { return obj.opacity >= 0.0 && obj.opacity <= 1.0 })) {
                $("#node-colorgradient-error").text("All opacity values should be between 0.0 and 1.0")
                $("#node-colorgradient-error").show();
                return false
            }
            else {
                // Valid color gradient
                $("#node-colorgradient-error").hide();
                return true
            }
        }

        RED.nodes.registerType('ui-heatmap', {
            category: RED._('@flowfuse/node-red-dashboard/ui-base:ui-base.label.category'),
            color: RED._('@flowfuse/node-red-dashboard/ui-base:ui-base.colors.light'),
            defaults: {
                group: { type: 'ui-group', required: true },
                name: { value: '' },
                label: { value: 'heatmap' },
                order: { value: 0 },
                width: {
                    value: 0,
                    validate: function (v) {
                        const width = v || 0
                        const currentGroup = $('#node-input-group').val() || this.group
                        const groupNode = RED.nodes.node(currentGroup)
                        const valid = !groupNode || +width <= +groupNode.width
                        $('#node-input-size').toggleClass('input-error', !valid)
                        return valid
                    }
                },
                height: { value: 0 },
                passthru: { value: true },
                className: { value: '' },
                // Heatmap specific properties
                rows: { value: 10, required: true},
                columns: { value: 10, required: true},
                pointRadius: { value: 2.0 },
                minDataValue: { value: null },
                maxDataValue: { value: null },
                opacityFactor: { value: 1.0 },
                rotationAngle: { value: 0.0 },
                translateX: { value: 0 },
                translateY: { value: 0 },
                zoomFactor: { value: 1.0 },
                colorGradient: { value: [{
                        color: '#000000', // Black
                        opacity: 0.00,
                        offset: 0
                    },
                    {
                        color: '#0000FF', // Blue
                        opacity: 0.2,
                        offset: 0.2
                    },
                    {
                        color: '#00FF00', // Green
                        opacity: 0.5,
                        offset: 0.45
                    },
                    {
                        color: '#FFFF00', // Yellow
                        opacity: 1.0,
                        offset: 0.85
                    },
                    {
                        color: '#FF0000', // Red
                        opacity: 1.0,
                        offset: 1.0
                    }],
                    validate: function (v) {
                        return validateColorGradient(v)
                    }
                },
                backgroundImageUrl: { value: "" }
            },
            inputs: 1,
            outputs: 1,
            outputLabels: function () { return this.mode },
            icon: 'font-awesome/fa-i-cursor',
            paletteLabel: 'heatmap',
            oneditprepare: function () {
                let node = this

                $('#node-input-size').elementSizer({
                    width: '#node-input-width',
                    height: '#node-input-height',
                    group: '#node-input-group'
                })

                // Show tabsheets
                node.tabs = RED.tabs.create({
                    id: "node-heatmap-tabsheets",
                    onchange: function(tab) {
                        node.currentTabId = tab.id

                        // Show only the content (i.e. the children) of the selected tabsheet, and hide the others
                        $("#node-heatmap-tabsheets-content").children().hide()
                        $("#" + tab.id).show()
                    }
                })
                node.tabs.addTab({
                    id: "node-heatmap-tabsheet-settings",
                    label: "Settings"
                })
                node.tabs.addTab({
                    id: "node-heatmap-tabsheet-colorgradient",
                    label: "Color gradient"
                })

                $('#node-input-topic').typedInput({
                    default: 'str',
                    typeField: $('#node-input-topicType'),
                    types: ['str', 'msg', 'flow', 'global']
                })

                $('#node-input-backgroundImageUrl').typedInput({
                    default: 'str',
                    types: ['str']
                })

                // use jQuery UI tooltip to convert the plain old title attribute to a nice tooltip
                $('.ui-node-popover-title').tooltip({
                    show: {
                        effect: 'slideDown',
                        delay: 150
                    }
                })

                $('#node-input-mode').on('change', (evt) => {
                    const mode = $('#node-input-mode').find(':selected').val()
                    if (mode === 'textarea') {
                        this.sendOnEnter = false
                        $('#node-input-container-sendOnEnter').hide()
                    } else {
                        $('#node-input-container-sendOnEnter').show()
                    }
                })

                $('#node-input-delay').on('change', (evt) => {
                    const delay = $('#node-input-delay').val()
                    if (delay === '' || delay === '0') {
                        this.sendOnDelay = false
                        if ($('#node-input-sendOnDelay').is(':checked')) {
                            $('#node-input-sendOnDelay').click()
                        }
                    } else {
                        this.sendOnDelay = true
                        if (!$('#node-input-sendOnDelay').is(':checked')) {
                            $('#node-input-sendOnDelay').click()
                        }
                    }
                })

                let colorGradientList = $("#node-input-colorgradient-container").css('min-height','200px').editableList({
                    header: $("<div>").css('padding-left','32px').append($.parseHTML(
                       "<div style='width:30%; display: inline-grid'><b>Offset</b></div>" +
                       "<div style='width:30%; display: inline-grid'><b>Color</b></div>" +
                       "<div style='width:30%; display: inline-grid'><b>Opacity</b></div>" )),
                    addItem: function(colorgradientContainer, i, colorGradientItem) {
                        // Add a new row to the editableList
                        let row = $('<div/>').appendTo(colorgradientContainer)

                        // Column 1 : Add a numeric input field to the new row, that represents the offset
                        let offsetField = $('<input/>',{class:"node-input-colorgradient-offset",type:"number",min:"0",max:"1",step:"0.01"}).css({"width":"30%","margin-left":"5px","margin-right":"5px"}).appendTo(row)
                        offsetField.val(colorGradientItem.offset)
                        offsetField.on("input", function() {
                            validateColorGradient()
                        })

                        // Column 2 : Add a color input field to the new row, that represents the color
                        let colorField = $('<input/>',{class:"node-input-colorgradient-color",type:"color"}).css({"width":"30%","margin-left":"5px","margin-right":"5px"}).appendTo(row)
                        colorField.val(colorGradientItem.color)
                        colorField.on("input", function() {
                            validateColorGradient()
                        })


                        // Column 3 : Add a numeric input field to the new row, that represents the opacity
                        let opacityField = $('<input/>',{class:"node-input-colorgradient-opacity",type:"number",min:"0",max:"1",step:"0.1"}).css({"width":"30%","margin-left":"5px"}).appendTo(row)
                        opacityField.val(colorGradientItem.opacity)
                        opacityField.on("input", function() {
                            validateColorGradient()
                        })

                        validateColorGradient()
                    },
                    removeItem: function(data) {
                        validateColorGradient()
                    },
                    sortItems: function(items) {
                        validateColorGradient()
                    },
                    removable: true,
                    sortable:true
                })

                // Copy all the color gradient items from this node to the editableList
                if (node.colorGradient) {
                    node.colorGradient.forEach(function (colorGradientItem, index) {
                        colorGradientList.editableList('addItem', colorGradientItem)
                    })
                }
            },
            oneditsave: function() {
                let node = this

                // Copy all the color gradient items from the editableList to this node
                node.colorGradient = []
                let colorGradientList = $("#node-input-colorgradient-container").editableList('items')
                colorGradientList.each(function(i) {
                    let colorGradientItem = $(this)
                    let offset = colorGradientItem.find(".node-input-colorgradient-offset").val()
                    let color = colorGradientItem.find(".node-input-colorgradient-color").val()
                    let opacity = colorGradientItem.find(".node-input-colorgradient-opacity").val()
                    node.colorGradient.push({offset:offset, color:color, opacity: opacity})
                })
            },
            label: function () {
                return this.name || (~this.label.indexOf('{' + '{') ? null : this.label) || this.mode + ' input'
            },
            labelStyle: function () { return this.name ? 'node_label_italic' : '' }
        })
    })()
</script>

<script type="text/html" data-template-name="ui-heatmap">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-i-cursor"></i> Label</label>
        <input type="text" id="node-input-label">
    </div>
    <div class="form-row">
        <label for="node-input-className"><i class="fa fa-code"></i> Class</label>
        <div style="display: inline;">
            <input style="width: 70%;" type="text" id="node-input-className" placeholder="Optional CSS class name(s)" style="flex-grow: 1;">
            <a
                data-html="true"
                title="Dynamic Property: Class names can also be set by sending a message to the node with a msg.topic of 'ui-property:class' and a payload containing the class name(s) to be applied. NOTE: classes set at runtime will be applied in addition to any class(es) set in the nodes class field."
                class="red-ui-button ui-node-popover-title"
                style="margin-left: 4px; cursor: help; font-size: 0.625rem; border-radius: 50%; width: 24px; height: 24px; display: inline-flex; justify-content: center; align-items: center;">
                <i style="font-family: ui-serif;">fx</i>
            </a>
        </div>
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-passthru"><i class="fa fa-arrow-right"></i> If <code>msg</code> arrives on input, pass through to output: </label>
        <input type="checkbox" checked id="node-input-passthru" style="display:inline-block; width:auto; margin-top: 0; margin-left: 3px;">
    </div>
    <div class="form-row">
        <!-- Tabsheets -->
        <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="node-heatmap-tabsheets"></ul>
    </div>
    <div id="node-heatmap-tabsheets-content" style="min-height: 150px">
        <!-- Content of all tabsheets -->
        <div id="node-heatmap-tabsheet-settings" class="node-heatmap-tabsheet-content" style="position: relative; margin-top: 30px;">
            <div class="form-row">
                <label for="node-input-rows"><i class="fa fa-arrows-alt"></i> Grid size</label>
                <span for="node-input-rows">Rows</span>
                <input type="text" id="node-input-rows" style="width:80px" min="1">
                <span for="node-input-columns" style="margin-left:20px;"> Columns</span>
                <input type="text" id="node-input-columns" style="width:80px" min="1">
            </div>
            <div class="form-row">
                <label for="node-input-pointRadius"><i class="fa fa-bullseye"></i> Radius</label>
                <input type="number" id="node-input-pointRadius" min="0.1" step="0.1">
            </div>
            <div class="form-row">
                <label for="node-input-minDataValue"><i class="fa fa-level-up"></i> Min value</label>
                <input type="number" id="node-input-minDataValue" min="0" step="1">
            </div>
            <div class="form-row">
                <label for="node-input-maxDataValue"><i class="fa fa-level-down"></i> Max value</label>
                <input type="number" id="node-input-maxDataValue" min="0" step="1">
            </div>
            <div class="form-row">
                <label for="node-input-opacityFactor"><i class="fa fa-low-vision"></i> Opacity</label>
                <input type="number" id="node-input-opacityFactor" min="0" max="1" step="0.1">
            </div>
            <div class="form-row">
                <label for="node-input-rotationAngle"><i class="fa fa-repeat"></i> Angle</label>
                <input type="number" id="node-input-rotationAngle" min="0" max="360" step="1">
            </div>
            <div class="form-row">
                <label for="node-input-translateX"><i class="fa fa-arrows-h"></i> X</label>
                <input type="number" id="node-input-translateX" min="0" step="1">
            </div>
            <div class="form-row">
                <label for="node-input-translateY"><i class="fa fa-arrows-v"></i> Y</label>
                <input type="number" id="node-input-translateY" min="0" step="1">
            </div>
            <div class="form-row">
                <label for="node-input-zoomFactor"><i class="fa fa-search"></i> Zoom</label>
                <input type="number" id="node-input-zoomFactor" min="1.0" step="0.1">
            </div>
            <div class="form-row">
                <label for="node-input-backgroundImageUrl"><i class="fa fa-picture-o"></i> Background</label>
                <input type="text" id="node-input-backgroundImageUrl">
            </div>
        </div>
        <div id="node-heatmap-tabsheet-colorgradient" class="node-heatmap-tabsheet-content" style="position: relative; margin-top: 30px;">
            <div class="form-row">
                <!-- Editable table container for color gradient -->
                <ol id="node-input-colorgradient-container"></ol>
            </div>
            <div class="form-row" style="margin-bottom:0;">
                <div id="node-colorgradient-error" class="form-tips" style="max-width: none;font-weight: bold;color: red;"></div>
            </div>
        </div>
</script>
